---
title: "Open Research Survey Report"
author: "Emma Wilson"
date: "22/02/2021"
output: 
    html_document:
      theme: cosmo
---

```{r select, include=FALSE}
# Choose the data to run the report on
choose <- c("all", "mrc", "uob", "babraham")[1]
```

```{r logo, echo=FALSE}
htmltools::img(src = knitr::image_uri(file.path("logo.jpg")), 
               alt = 'UKRN logo', 
               style = 'position:absolute; top:0; right:0; padding:25px 250px;')
```

---

```{r setup, include=FALSE}
# R packages
library(tidyverse)    # Tivdyverse packages
# Functions
source("functions/format_distribution.R") # Create a histogram of responses
source("functions/format_leadership.R")   # Format MajorleadershipRole for graph
source("functions/format_priority.R")     # Format OR area priority responses
source("functions/format_training.R")     # Format training responses for graph
source("functions/read_survey.R")         # Read in and format survey data
# KnitR
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r data, include=FALSE}
# Clean column text
col_order <- read_csv("data-helpers/colOrder.csv")
# MRC taxonomy
mrc_group <- read_csv("data-helpers/mrcTaxonomy.csv")

# Read in survey data
dat_mrc <- read_survey("data", "MRC") # MRC-funded institutions
dat_uob <- read_survey("data", "UoB") # University of Bristol
dat_bab <- read_survey("data", "Babraham") # Babraham Institute
# Bind into one dataframe
dat <- rbind(dat_mrc, dat_uob, dat_bab)

# Clear environment
rm(col_order, dat_bab, dat_mrc, dat_uob, mrc_group)

# Select relevant data
if(choose == "all"){
  dat <- dat
} else if(choose == "mrc"){
  dat <- filter(dat, Unit == "MRC")
} else if(choose == "uob"){
  dat <- filter(dat, Unit == "UoB")
} else if(choose == "babraham"){
  dat <- filter(dat, Unit == "Babraham")
}

# Format MajorLeadership Role Column
dat <- format_leadership(dat)
```

# Survey Data
<!-- fix factors in graphs -->

```{r, echo=FALSE, results='asis'}
if(choose == "all"){
  # Number of responses text
  cat('This report summarises', nrow(dat), 'survey responses from life and health sciences researchers at Medical Research Council (MRC)-funded institutions, The University of Bristol, and The Babraham Institute. \n\n')
  # Research domain / discipline
  ggplot(dat, aes(x = factor(Unit))) +
  geom_bar(aes(fill = Discipline)) +
  scale_fill_manual(values = c("#28295B", "#4E4F86", "#9e9e9e")) +
  ylim(0, nrow(dat)) +
  theme(legend.position="bottom", legend.text = element_text(size = 7)) +
  xlab("Organisation") + ylab("Number of Responses") +
  theme(plot.title = element_text(hjust = 0.5))
} else if(choose == "mrc"){
  # Number of responses text
  cat('This report summarises', nrow(dat), 'survey responses from life and health sciences researchers at Medical Research Council (MRC)-funded institutions. \n\n')
  # Research domain / discipline
  ggplot(dat, aes(x = factor(Primary))) +
  geom_bar(aes(fill = Discipline)) +
  scale_fill_manual(values = c("#28295B", "#4E4F86", "#9e9e9e")) +
  ylim(0, nrow(dat)) +
  theme(legend.position="bottom", legend.text = element_text(size = 7)) +
  xlab("Research Domain") + ylab("Number of Responses") +
  theme(plot.title = element_text(hjust = 0.5))
} else if(choose == "uob"){
  # Number of responses text
  cat('This report summarises', nrow(dat), 'survey responses from life and health sciences researchers at The University of Bristol.')
} else if(choose == "babraham"){
  # Number of responses text
  cat('This report summarises', nrow(dat), 'survey responses from life sciences researchers at The Babraham Institute.')
} else {
  cat('Error: Please choose a valid data breakdown.')
}
```

## Leadership Roles

```{r leadership, echo=FALSE}
count(dat, Leadership) %>%
  ggplot(aes(x = Leadership, y = n)) +
  geom_bar(fill = "#4E4F86", stat = "identity") +
  ylim(0, nrow(dat)) +
  xlab("Leadership role") + ylab("Number of Responses") +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  theme(plot.title = element_text(hjust = 0.5))
```

